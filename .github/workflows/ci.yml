name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node 20.19.4 (npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.4
          cache: 'npm'
          cache-dependency-path: |
            npm-shrinkwrap.json
            backend/package-lock.json
      - name: Print Node & npm versions
        run: |
          echo "Runner versions"
          node --version || true
          npm --version || true
      - name: ðŸ” Verify npm lockfiles exist
        run: |
          if [ ! -f npm-shrinkwrap.json ]; then
            echo 'âŒ Missing npm-shrinkwrap.json. Run `npm shrinkwrap` locally.'
            exit 1
          fi
          if [ ! -f backend/package-lock.json ]; then
            echo 'âŒ Missing backend/package-lock.json. Run `npm --prefix backend install --package-lock-only`.'
            exit 1
          fi
          echo 'âœ… npm lockfiles verified.'
      - name: Install dependencies (root)
        run: npm ci
      - name: Install dependencies (backend)
        run: npm --prefix backend ci
      - name: Typecheck
        run: npm run typecheck
      - name: Lint
        run: npm run lint
      - name: Prettier formatting check
        run: npm run format:check
      - name: Run tests
        run: npm test -- --ci --passWithNoTests

  build-android-preview:
    needs: test
    runs-on: ubuntu-latest
    # outputs:
      # ftl_url: ${{ steps.ftl.outputs.results_url }}  # Commented out with Firebase Test Lab
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      GCLOUD_PROJECT_ID: ${{ secrets.GC_PROJECT_ID }}
      GCP_SA_KEY_JSON: ${{ secrets.GCP_SA_KEY_JSON }}
      GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
      EXPO_ANDROID_KEYSTORE_BASE64: ${{ secrets.EXPO_ANDROID_KEYSTORE_BASE64 }}
      EXPO_ANDROID_KEYSTORE_PASSWORD: ${{ secrets.EXPO_ANDROID_KEYSTORE_PASSWORD }}
      EXPO_ANDROID_KEY_ALIAS: ${{ secrets.EXPO_ANDROID_KEY_ALIAS }}
      EXPO_ANDROID_KEY_PASSWORD: ${{ secrets.EXPO_ANDROID_KEY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node 20.19.4 (npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.4
          cache: 'npm'
          cache-dependency-path: |
            npm-shrinkwrap.json
            backend/package-lock.json
      - name: Print Node & npm versions
        run: |
          echo "Runner versions"
          node --version || true
          npm --version || true
      - name: ðŸ” Verify npm lockfiles exist
        run: |
          if [ ! -f npm-shrinkwrap.json ]; then
            echo 'âŒ Missing npm-shrinkwrap.json. Run `npm shrinkwrap` locally.'
            exit 1
          fi
          if [ ! -f backend/package-lock.json ]; then
            echo 'âŒ Missing backend/package-lock.json. Run `npm --prefix backend install --package-lock-only`.'
            exit 1
          fi
          echo 'âœ… npm lockfiles verified.'
      - name: Install dependencies (root)
        run: npm ci
      - name: Install dependencies (backend)
        run: npm --prefix backend ci

      - name: Ensure EAS secret GOOGLE_SERVICES_JSON_BASE64
        if: ${{ env.GOOGLE_SERVICES_JSON_BASE64 != '' }}
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
        run: |
          set -euo pipefail
          sudo apt-get update -y && sudo apt-get install -y jq
          echo "ðŸ” Syncing EAS secret: GOOGLE_SERVICES_JSON_BASE64"
          npx -y eas-cli@latest whoami || true
          EXISTING=$(npx -y eas-cli@latest secret:list --json | jq -r '.[] | select(.name=="GOOGLE_SERVICES_JSON_BASE64" and .scope=="project") | .id' || true)
          if [ -n "$EXISTING" ]; then
            echo "Found existing secret id=$EXISTING. Deleting to update..."
            npx -y eas-cli@latest secret:delete --id "$EXISTING" --non-interactive || true
          fi
          npx -y eas-cli@latest secret:create \
            --non-interactive \
            --name GOOGLE_SERVICES_JSON_BASE64 \
            --value "$GOOGLE_SERVICES_JSON_BASE64" \
            --scope project \
            --type string
          echo "âœ… EAS secret synchronized."

      - name: Create Android credentials.json (local keystore)
        if: ${{ env.EXPO_ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          set -euo pipefail
          echo "$EXPO_ANDROID_KEYSTORE_BASE64" | base64 -d > android.keystore
          cat > credentials.json <<'JSON'
          {
            "android": {
              "keystore": {
                "keystorePath": "android.keystore",
                "keystorePassword": "${EXPO_ANDROID_KEYSTORE_PASSWORD}",
                "keyAlias": "${EXPO_ANDROID_KEY_ALIAS}",
                "keyPassword": "${EXPO_ANDROID_KEY_PASSWORD}"
              }
            }
          }
          JSON
          echo "âœ… Created credentials.json with local keystore"

      - name: Prebuild native Android project
        run: npx expo prebuild --clean --platform android

      - name: Install EAS CLI globally
        run: npm install -g eas-cli

      - name: Build Android Preview APK (no store creds)
        id: eas_build
        run: |
          BUILD_OUTPUT=$(eas build --platform android --profile android-preview --non-interactive --clear-cache --json)
          echo "$BUILD_OUTPUT"
          BUILD_ID=$(echo "$BUILD_OUTPUT" | jq -r '(.[0].id // .id // .buildId // .[0].buildId)')
          ARTIFACT_URL=$(echo "$BUILD_OUTPUT" | jq -r '(.[0].artifacts.applicationArchiveUrl // .artifacts[0].applicationArchiveUrl // .applicationArchiveUrl)')
          if [ -z "$BUILD_ID" ]; then
            echo "Error: Could not extract build ID from EAS output"
            echo "Build output was: $BUILD_OUTPUT"
            exit 1
          fi
          if [ -z "$ARTIFACT_URL" ] || [ "$ARTIFACT_URL" = "null" ]; then
            echo "Error: Could not extract artifact URL from EAS output"
            echo "Build output was: $BUILD_OUTPUT"
            exit 1
          fi
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "ARTIFACT_URL=$ARTIFACT_URL" >> $GITHUB_OUTPUT
          echo "âœ… Android build completed with ID: $BUILD_ID"

      - name: Download EAS Android artifact (APK)
        run: |
          curl -L "${{ steps.eas_build.outputs.ARTIFACT_URL }}" -o app-preview.apk
          test -f app-preview.apk
          echo "âœ… Downloaded APK: app-preview.apk"

      - name: Upload APK artifact (preserve)
        uses: actions/upload-artifact@v4
        with:
          name: android-preview-apk
          path: app-preview.apk
          if-no-files-found: error

      - name: (Info) Skipping FTL â€” secrets missing or PR is from a fork
        if: ${{ (env.GCLOUD_PROJECT_ID == '' || env.GCP_SA_KEY_JSON == '') || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork) }}
        run: |
          echo "Skipping Firebase Test Lab due to missing secrets or forked PR."
          echo "### Firebase Test Lab (Robo) â€” Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Reason: secrets not available or forked PR." >> $GITHUB_STEP_SUMMARY

      - name: Authenticate to Google Cloud
        if: ${{ (env.GCLOUD_PROJECT_ID != '' && env.GCP_SA_KEY_JSON != '') && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SA_KEY_JSON }}

      - name: Set up gcloud SDK
        if: ${{ (env.GCLOUD_PROJECT_ID != '' && env.GCP_SA_KEY_JSON != '') && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCLOUD_PROJECT_ID }}

      # Firebase Test Lab - Commented out temporarily (can be re-enabled by buyer)
      # Uncomment the section below to enable Firebase Test Lab Android testing
      # - name: Run Firebase Test Lab (Robo) on APK
      #   id: ftl
      #   if: ${{ (env.GCLOUD_PROJECT_ID != '' && env.GCP_SA_KEY_JSON != '') && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
      #   run: |
      #     set -euo pipefail
      #     # Using walleye (Pixel 2) - known reliable device in Firebase Test Lab
      #     # Alternative devices: bullhead,version=30 (Nexus 5X) or hammerhead,version=30
      #     DEVICE="model=walleye,version=30,locale=en,orientation=portrait"
      #     EXIT_CODE=0
      #     gcloud firebase test android run \
      #       --type robo \
      #       --app app-preview.apk \
      #       --device "$DEVICE" \
      #       --timeout 900s \
      #       || EXIT_CODE=$?
      #     RESULTS_URL=$(grep -Eo 'More details are available at: https://console.developers.google.com/storage/browser/[^ ]+' "$HOME/.config/gcloud/logs/"* 2>/dev/null | tail -n1 | awk '{print $NF}') || true
      #     echo "results_url=${RESULTS_URL:-}" >> $GITHUB_OUTPUT
      #     if [ "$EXIT_CODE" -ne 0 ]; then
      #       echo "::error::Firebase Test Lab reported failures. See results: ${RESULTS_URL:-unknown}"
      #       exit $EXIT_CODE
      #     fi

      # - name: Summarize Firebase Test Lab results
      #   if: ${{ (env.GCLOUD_PROJECT_ID != '' && env.GCP_SA_KEY_JSON != '') && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
      #   run: |
      #     echo "### Firebase Test Lab (Robo) Results" >> $GITHUB_STEP_SUMMARY
      #     echo "" >> $GITHUB_STEP_SUMMARY
      #     echo "- Results: ${{ steps.ftl.outputs.results_url }}" >> $GITHUB_STEP_SUMMARY

  build-ios-simulator:
    needs: test
    runs-on: macos-latest
    outputs:
      appetize_url: ${{ steps.appetize.outputs.url }}
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      APPETIZE_API_TOKEN: ${{ secrets.APPETIZE_API_TOKEN }}
      APPETIZE_PUBLIC: ${{ vars.APPETIZE_PUBLIC }}
      GOOGLESERVICE_PLIST_BASE64: ${{ secrets.GOOGLESERVICE_PLIST_BASE64 }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node 20.19.4 (npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.4
          cache: 'npm'
          cache-dependency-path: |
            npm-shrinkwrap.json
            backend/package-lock.json
      - name: Print Node & npm versions
        run: |
          echo "Runner versions"
          node --version || true
          npm --version || true
      - name: ðŸ” Verify npm lockfiles exist
        run: |
          if [ ! -f npm-shrinkwrap.json ]; then
            echo 'âŒ Missing npm-shrinkwrap.json. Run `npm shrinkwrap` locally.'
            exit 1
          fi
          if [ ! -f backend/package-lock.json ]; then
            echo 'âŒ Missing backend/package-lock.json. Run `npm --prefix backend install --package-lock-only`.'
            exit 1
          fi
          echo 'âœ… npm lockfiles verified.'
      - name: Install dependencies (root)
        run: npm ci
      - name: Install dependencies (backend)
        run: npm --prefix backend ci

      - name: Verify iOS Podfile exists (fail early)
        run: |
          if [ ! -f ios/Podfile ]; then
            echo "âŒ ios/Podfile missing in repository root"
            echo "Repository tree (top-level):"
            ls -la
            echo "\nGit status:"
            git status --porcelain=v1
            exit 1
          fi
          echo "âœ… ios/Podfile present"

      - name: Write GoogleService-Info.plist
        if: ${{ env.GOOGLESERVICE_PLIST_BASE64 != '' }}
        run: |
          echo "${{ env.GOOGLESERVICE_PLIST_BASE64 }}" | base64 --decode > ios/JARS/GoogleService-Info.plist
          echo "âœ… GoogleService-Info.plist written"

      - name: Check vendored Stripe status
        run: |
          if [ -d ios/Vendor/Stripe ]; then
            echo "âœ… Vendored Stripe found - using offline-friendly pod install"
            echo "USE_VENDORED_STRIPE=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ Vendored Stripe not found - using standard pod install"
            echo "USE_VENDORED_STRIPE=false" >> $GITHUB_ENV
          fi

      - name: Install CocoaPods
        run: |
          set -euo pipefail
          sudo gem install cocoapods --no-document
          pod --version

      - name: Install CocoaPods (with optional vendored Stripe)
        run: |
          set -euo pipefail
          cd ios

          if [ "$USE_VENDORED_STRIPE" = "true" ]; then
            echo "Using offline-friendly pod install with vendored Stripe"
            pod deintegrate || true
          else
            echo "Using standard pod install (no vendored Stripe)"
          fi

          attempt_pod_install () {
            pod install --repo-update && return 0
            return 1
          }

          if ! attempt_pod_install; then
            echo 'pod install failed, retrying in 10s...'
            sleep 10
            if ! attempt_pod_install; then
              echo 'pod install failed again, retrying in 30s...'
              sleep 30
              attempt_pod_install
            fi
          fi

      - name: Build iOS simulator .app via xcodebuild
        run: |
          set -euo pipefail
          cd ios
          xcodebuild \
            -workspace JARS.xcworkspace \
            -scheme JARS \
            -sdk iphonesimulator \
            -configuration Release \
            -derivedDataPath build

      - name: Package simulator app
        run: |
          set -euo pipefail
          cd ios/build/Build/Products/Release-iphonesimulator
          APP_NAME=$(ls -d *.app | head -n 1)
          zip -r "$APP_NAME.zip" "$APP_NAME"
          mv "$APP_NAME.zip" ../../../JARS-simulator.zip

      - name: Upload iOS Simulator artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-build
          path: ios/build/JARS-simulator.zip
          if-no-files-found: error

      - name: (Info) Skipping Appetize â€” token missing or PR is from a fork
        if: ${{ (env.APPETIZE_API_TOKEN == '') || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork) }}
        run: |
          echo "Skipping Appetize upload."
          echo "### Appetize â€” Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Reason: secrets not available or forked PR." >> $GITHUB_STEP_SUMMARY
          echo "- iOS Simulator artifact uploaded as 'ios-simulator-build'." >> $GITHUB_STEP_SUMMARY

      - name: Upload iOS build to Appetize
        if: ${{ (env.APPETIZE_API_TOKEN != '') && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
        id: appetize
        continue-on-error: true
        run: |
          set -euo pipefail
          
          # Cross-platform jq installation
          if command -v jq >/dev/null 2>&1; then
            echo "jq already available"
          elif [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update -y && sudo apt-get install -y jq
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install jq 2>/dev/null || { echo "jq installation failed, continuing without..."; }
          else
            echo "Warning: jq not available on this platform"
          fi
          
          # Find the correct iOS simulator file
          if [ -f "ios/build/JARS-simulator.zip" ]; then
            IOS_FILE="ios/build/JARS-simulator.zip"
          elif [ -f "ios-simulator.tar.gz" ]; then
            IOS_FILE="ios-simulator.tar.gz"
          elif [ -f "ios-simulator.zip" ]; then
            IOS_FILE="ios-simulator.zip"
          else
            echo "Error: No iOS simulator build file found"
            echo "Available files:"
            find . -name "*.zip" -o -name "*.tar.gz" | head -10
            exit 1
          fi
          
          echo "Using iOS file: $IOS_FILE"
          PUBLIC_FLAG="${APPETIZE_PUBLIC:-false}"
          
          # Upload to Appetize with proper error handling
          if command -v jq >/dev/null 2>&1; then
            RESP_JSON=$(curl -sS -X POST https://api.appetize.io/v2/apps \
              -H "Authorization: Bearer ${APPETIZE_API_TOKEN}" \
              -H "Content-Type: multipart/form-data" \
              -F "platform=ios" \
              -F "file=@${IOS_FILE}" \
              -F "note=Jars iOS Simulator build ${GITHUB_SHA}" \
              -F "public=${PUBLIC_FLAG}")
            echo "${RESP_JSON}" > appetize_response.json
            PUBLIC_KEY=$(echo "$RESP_JSON" | jq -r '.publicKey // empty')
            DASH_URL=$(echo "$RESP_JSON" | jq -r '.dashboardUrl // .publicURL // .appURL // empty')
          else
            # Fallback without jq parsing
            echo "Uploading without jq parsing..."
            RESP_JSON=$(curl -sS -X POST https://api.appetize.io/v2/apps \
              -H "Authorization: Bearer ${APPETIZE_API_TOKEN}" \
              -H "Content-Type: multipart/form-data" \
              -F "platform=ios" \
              -F "file=@${IOS_FILE}" \
              -F "note=Jars iOS Simulator build ${GITHUB_SHA}" \
              -F "public=${PUBLIC_FLAG}")
            echo "${RESP_JSON}" > appetize_response.json
            PUBLIC_KEY=""
            DASH_URL=""
          fi
          
          # Set output URL
          if [ -n "$PUBLIC_KEY" ]; then
            APP_URL="https://appetize.io/app/${PUBLIC_KEY}"
          elif [ -n "$DASH_URL" ]; then
            APP_URL="$DASH_URL"
          else
            APP_URL=""
          fi
          echo "url=${APP_URL}" >> $GITHUB_OUTPUT

      - name: Upload Appetize API response (artifact)
        if: steps.appetize.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: appetize-response
          path: appetize_response.json

      - name: Summarize Appetize upload (success)
        if: steps.appetize.outcome == 'success'
        run: |
          echo "### Appetize â€” iOS Simulator âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.appetize.outputs.url }}" ]; then
            echo "- Launch: ${{ steps.appetize.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Upload succeeded. See 'appetize-response' artifact for details and shareable link." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Summarize Appetize upload (failure)
        if: steps.appetize.outcome == 'failure'
        run: |
          echo "### Appetize â€” iOS Simulator âš ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Upload failed, but iOS build artifact is still available" >> $GITHUB_STEP_SUMMARY
          echo "- Download 'ios-simulator-build' artifact for manual testing" >> $GITHUB_STEP_SUMMARY

  post-summary:
    needs: [build-android-preview, build-ios-simulator]
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false }}
    steps:
      - name: Post preview links as PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ðŸš€ JARS Mobile Preview Build Ready
            **Artifacts**
            - [Android APK](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [iOS Simulator tar.gz](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Live Testing**
            - Appetize iOS Simulator: ${{ needs.build-ios-simulator.outputs.appetize_url || 'N/A' }}
            - Firebase Test Lab Results: Disabled (can be re-enabled in CI configuration)
            *(automatically generated by CI)*
