name: e2e-smoke
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_OPTIONS: --max-old-space-size=4096

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Use Node and enforce Yarn lockfile
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          cache: 'npm'
          cache-dependency-path: |
            npm-shrinkwrap.json

      - name: üîç Preflight - Verify npm lockfiles exist
        run: |
          if [ ! -f npm-shrinkwrap.json ]; then
            echo '‚ùå Missing npm-shrinkwrap.json. Run `npm shrinkwrap` locally.'
            exit 1
          fi
          if [ ! -f backend/package-lock.json ]; then
            echo '‚ùå Missing backend/package-lock.json. Run `npm --prefix backend install --package-lock-only`.'
            exit 1
          fi
          echo '‚úÖ npm lockfiles verified.'

      - name: Verify lockfile consistency
        run: |
          if ! grep -q '"picomatch"' npm-shrinkwrap.json; then
            echo "‚ùå Drift detected: picomatch missing in shrinkwrap."
            echo "Re-run: npm install && npm shrinkwrap"
            exit 1
          fi

          # Validate shrinkwrap resolves all dependencies
          npm ls > /dev/null || {
            echo "‚ùå Dependency tree mismatch"
            exit 1
          }

          echo "‚úÖ Lockfile consistency verified."

      - name: Install deps (root)
        run: npm ci --omit=optional

      - name: Install deps (backend)
        run: npm --prefix backend ci --omit=optional

      - name: Check for modified lockfiles
        run: |
          if ! git diff --exit-code npm-shrinkwrap.json; then
            echo "‚ùå Lockfile drift detected after build"
            exit 1
          fi

      - name: Prepare Android SDK cache directories
        run: |
          sudo mkdir -p /usr/lib/android-sdk/{platforms,build-tools,emulator,platform-tools,system-images}
          sudo chown -R $USER:$(id -gn) /usr/lib/android-sdk
          mkdir -p ~/.android/avd

      - name: Cache Android SDK components
        uses: actions/cache@v4
        with:
          path: |
            /usr/lib/android-sdk/platforms
            /usr/lib/android-sdk/build-tools
            /usr/lib/android-sdk/emulator
            /usr/lib/android-sdk/platform-tools
            /usr/lib/android-sdk/system-images
          key: ${{ runner.os }}-android-sdk-${{ hashFiles('.github/workflows/e2e-smoke.yml') }}

      - name: Cache Android AVD (optional)
        uses: actions/cache@v4
        with:
          path: ~/.android/avd
          key: ${{ runner.os }}-android-avd-${{ hashFiles('.github/workflows/e2e-smoke.yml', 'e2e/detox.config.js') }}

      # Build APK with EAS
      - name: Expo/EAS auth (npm only)
        uses: expo/expo-github-action@v8
        with:
          token: ${{ secrets.EXPO_TOKEN }}
          packager: npm
          expo-version: latest
          eas-version: latest
          expo-cache: true
          eas-cache: true
          patch-watchers: true

      - name: Write google-services.json
        env:
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
        run: |
          if [ -z "$GOOGLE_SERVICES_JSON_BASE64" ]; then
            echo "GOOGLE_SERVICES_JSON_BASE64 not set; skipping google-services.json creation"
            exit 0
          fi
          mkdir -p ./apps/android
          echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 --decode > ./apps/android/google-services.json

      - name: Run expo prebuild (Android)
        run: npx expo prebuild --platform android --clean --no-install

      - name: Create Android credentials.json (local keystore)
        env:
          EXPO_ANDROID_KEYSTORE_BASE64: ${{ secrets.EXPO_ANDROID_KEYSTORE_BASE64 }}
          EXPO_ANDROID_KEYSTORE_PASSWORD: ${{ secrets.EXPO_ANDROID_KEYSTORE_PASSWORD }}
          EXPO_ANDROID_KEY_ALIAS: ${{ secrets.EXPO_ANDROID_KEY_ALIAS }}
          EXPO_ANDROID_KEY_PASSWORD: ${{ secrets.EXPO_ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "$EXPO_ANDROID_KEYSTORE_BASE64" ]; then
            echo "::warning::EXPO_ANDROID_KEYSTORE_BASE64 not set; skipping credentials.json creation"
            echo "EAS will attempt to use remote credentials or fail if none available"
            exit 0
          fi
          echo "$EXPO_ANDROID_KEYSTORE_BASE64" | base64 -d > android.keystore
          cat > credentials.json <<EOF
          {
            "android": {
              "keystore": {
                "keystorePath": "android.keystore",
                "keystorePassword": "${EXPO_ANDROID_KEYSTORE_PASSWORD}",
                "keyAlias": "${EXPO_ANDROID_KEY_ALIAS}",
                "keyPassword": "${EXPO_ANDROID_KEY_PASSWORD}"
              }
            }
          }
          EOF
          echo "‚úÖ Created credentials.json with local keystore"

      - name: Build Android APK (EAS)
        run: |
          set -euo pipefail
          # Use system default Yarn for EAS compatibility
          yarn --version || true

          eas build -p android --profile android-preview --non-interactive --json > build.json
          cat build.json

      - name: Download APK artifact
        run: |
          set -euo pipefail
          URL=$(jq -r '.[0].artifacts.buildUrl // .artifacts.buildUrl' build.json)
          test -n "$URL" || (echo "No buildUrl in build.json"; cat build.json; exit 1)
          curl -L "$URL" -o app-release.apk
          ls -lh app-release.apk

      # Upload to Appetize (demo link)
      - name: Upload APK to Appetize (action removed)
        # The appetizeio/appetize-github-action repository is not available; use the API fallback step below instead.
        run: |
          echo "Note: appetizeio/appetize-github-action is not available. Using API upload step to Appetize instead."

      - name: Upload APK to Appetize (API fallback)
        # Don't reference secrets in the conditional; check at runtime and skip if missing
        if: ${{ github.event.pull_request == null || github.event.pull_request.head.repo.fork == false }}
        env:
          APPETIZE_API_TOKEN: ${{ secrets.APPETIZE_API_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "$APPETIZE_API_TOKEN" ]; then
            echo "APPETIZE_API_TOKEN not set; skipping API fallback upload"
            exit 0
          fi
          RESPONSE=$(curl -sS https://api.appetize.io/v1/apps \
            -u "$APPETIZE_API_TOKEN:" \
            -F "file=@app-release.apk" \
            -F "platform=android")
          PUB=$(echo "$RESPONSE" | jq -r '.publicKey // .data.publicKey // .app.publicKey // empty')
          echo "PUBLIC_KEY=$PUB" >> $GITHUB_ENV
          echo "### Appetize Demo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Dashboard:** https://appetize.io/app/$PUB" >> $GITHUB_STEP_SUMMARY
          echo "- **Embed:** https://appetize.io/embed/$PUB?device=pixel7&osVersion=14.0&scale=75&autoplay=true" >> $GITHUB_STEP_SUMMARY

      - name: Appetize links
        if: ${{ github.event.pull_request == null || github.event.pull_request.head.repo.fork == false }}
        env:
          APPETIZE_PUBLIC_KEY_SECRET: ${{ secrets.APPETIZE_PUBLIC_KEY }}
        run: |
          # Prefer an explicit APPETIZE_PUBLIC_KEY secret (stable), otherwise use PUBLIC_KEY set by API upload
          PUB="$APPETIZE_PUBLIC_KEY_SECRET"
          if [ -z "$PUB" ]; then
            PUB="$PUBLIC_KEY"
          fi
          if [ -n "$PUB" ]; then
            echo "### Appetize Demo" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Dashboard:** https://appetize.io/app/$PUB" >> $GITHUB_STEP_SUMMARY
            echo "- **Embed:** https://appetize.io/embed/$PUB?device=pixel7&osVersion=14.0&scale=75&autoplay=true" >> $GITHUB_STEP_SUMMARY
          else
            echo "No Appetize public key available; upload may have failed or been skipped." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Typecheck & lint (root)
        run: |
          npm run typecheck
          npm run lint

      - name: Typecheck & lint (backend)
        run: |
          npm run typecheck || true
          npm run lint || true
        working-directory: backend

      - name: Firebase Test Lab Robo smoke
        # Do a runtime check for GCP secrets to avoid using secrets in the workflow expression
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_SA_KEY_JSON: ${{ secrets.GCP_SA_KEY_JSON }}
        run: |
          set -euo pipefail
          if [ -z "$GCP_PROJECT_ID" ] || [ -z "$GCP_SA_KEY_JSON" ]; then
            echo "GCP_PROJECT_ID or GCP_SA_KEY_JSON not set; skipping Firebase Test Lab run"
            exit 0
          fi
          echo "$GCP_SA_KEY_JSON" > /tmp/gcloud_key.json
          gcloud auth activate-service-account --key-file=/tmp/gcloud_key.json
          gcloud config set project "$GCP_PROJECT_ID"
          gcloud firebase test android run \
            --type robo \
            --app app-release.apk \
            --device model=MediumPhone.arm,version=34,locale=en,orientation=portrait \
            --timeout 5m

      # Emulator fallback when FTL secrets are not present
      - name: Install Android SDK & tools (for emulator fallback)
        # This step will check at runtime whether GCP secrets are present; if they are, it will skip.
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_SA_KEY_JSON: ${{ secrets.GCP_SA_KEY_JSON }}
          ADB_INSTALL_TIMEOUT: 120000
        run: |
          set -euo pipefail
          if [ -n "$GCP_PROJECT_ID" ] && [ -n "$GCP_SA_KEY_JSON" ]; then
            echo "GCP secrets present; skipping emulator fallback SDK install"
            exit 0
          fi
          sudo mkdir -p /usr/lib/android-sdk || true
          sudo chown -R $USER:$(id -gn) /usr/lib/android-sdk || true
          export ANDROID_SDK_ROOT="/usr/lib/android-sdk"
          sudo apt-get update
          sudo apt-get install -y openjdk-11-jdk unzip
          curl -sS https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -o cmdline.zip
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          TMP_CLT_DIR=$(mktemp -d)
          unzip -q cmdline.zip -d "$TMP_CLT_DIR"
          rm -rf "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          mv "$TMP_CLT_DIR/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          SDKMANAGER_BIN="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          if [ ! -x "$SDKMANAGER_BIN" ]; then
            echo "‚ùå sdkmanager binary not found at $SDKMANAGER_BIN"
            ls -R "$ANDROID_SDK_ROOT/cmdline-tools" || true
            exit 1
          fi
          set +o pipefail
          yes | "$SDKMANAGER_BIN" --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "platforms;android-34" \
            "system-images;android-34;google_apis;arm64-v8a" \
            "emulator"
          SDK_EXIT=${PIPESTATUS[1]}
          set -o pipefail
          if [ $SDK_EXIT -ne 0 ]; then
            echo "‚ùå sdkmanager failed with exit code $SDK_EXIT"
            exit $SDK_EXIT
          fi

      - name: Create and configure AVD (fallback)
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_SA_KEY_JSON: ${{ secrets.GCP_SA_KEY_JSON }}
        run: |
          set -euo pipefail
          if [ -n "$GCP_PROJECT_ID" ] && [ -n "$GCP_SA_KEY_JSON" ]; then
            echo "GCP secrets present; skipping AVD creation"
            exit 0
          fi
          export ANDROID_SDK_ROOT="/usr/lib/android-sdk"
          export ANDROID_AVD_HOME="$HOME/.android/avd"
          mkdir -p "${ANDROID_AVD_HOME}"
          AVD_NAME="ci_arm64_avd"
          export AVD_NAME
          CMDLINE_TOOLS_BIN="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin"
          AVDMANAGER_BIN="$CMDLINE_TOOLS_BIN/avdmanager"
          if [ ! -x "$AVDMANAGER_BIN" ]; then
            echo "‚ùå avdmanager not found at $AVDMANAGER_BIN"
            ls -R "$CMDLINE_TOOLS_BIN/.." || true
            exit 1
          fi
          set +o pipefail
          printf 'no\n' | "$AVDMANAGER_BIN" create avd --force --name "${AVD_NAME}" --package "system-images;android-34;google_apis;arm64-v8a" --tag "google_apis" --abi "arm64-v8a" --device "Nexus 5"
          AVD_EXIT=${PIPESTATUS[1]}
          set -o pipefail
          if [ $AVD_EXIT -ne 0 ]; then
            echo "‚ùå avdmanager failed with exit code $AVD_EXIT"
            exit $AVD_EXIT
          fi
          AVD_DIR="$ANDROID_AVD_HOME/${AVD_NAME}.avd"
          {
            echo "hw.accel=off"
            echo "hw.gpu.enabled=yes"
            echo "hw.gpu.mode=swiftshader_indirect"
            echo "disk.dataPartition.size=2048M"
          } >> "${AVD_DIR}/config.ini"

      - name: Boot emulator (fallback)
        shell: bash
        env:
          AVD_NAME: ci_arm64_avd
          ANDROID_HOME: /usr/lib/android-sdk
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_SA_KEY_JSON: ${{ secrets.GCP_SA_KEY_JSON }}
        run: |
          set -euo pipefail
          if [ -n "$GCP_PROJECT_ID" ] && [ -n "$GCP_SA_KEY_JSON" ]; then
            echo "GCP secrets present; skipping emulator boot"
            exit 0
          fi
          export ANDROID_SDK_ROOT="${ANDROID_HOME}"
          export PATH="$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH"
          EMULATOR_BIN="$ANDROID_HOME/emulator/emulator"
          ADB_BIN="$ANDROID_HOME/platform-tools/adb"
          if [ ! -x "$EMULATOR_BIN" ]; then
            echo "‚ùå Emulator binary not found at $EMULATOR_BIN"
            ls -R "$ANDROID_HOME/emulator" || true
            exit 1
          fi
          if [ ! -x "$ADB_BIN" ]; then
            echo "‚ùå adb binary not found at $ADB_BIN"
            ls -R "$ANDROID_HOME/platform-tools" || true
            exit 1
          fi
          STATE_DIR="$RUNNER_TEMP/emulator-fallback"
          mkdir -p "$STATE_DIR"
          LOG_FILE="$STATE_DIR/emulator.log"
          PID_FILE="$STATE_DIR/pid"
          MAX_ATTEMPTS=2
          attempt=1
          launch_emulator() {
            rm -f "$LOG_FILE"
            "$ADB_BIN" kill-server || true
            "$ADB_BIN" start-server
            "$EMULATOR_BIN" -avd "${AVD_NAME}" -no-window -no-snapshot -gpu swiftshader_indirect -no-audio -no-boot-anim -no-metrics -camera-back none -camera-front none -selinux permissive -no-accel -ports 5554,5555 -writable-system -qemu -m 3072 > "$LOG_FILE" 2>&1 &
            EMULATOR_PID=$!
            echo $EMULATOR_PID > "$PID_FILE"
          }
          wait_for_boot() {
            local deadline=$((SECONDS + 900))
            until "$ADB_BIN" wait-for-device >/dev/null 2>&1; do
              if (( SECONDS > deadline )); then
                echo "‚ùå adb did not detect the emulator within 15 minutes"
                tail -n 200 "$LOG_FILE" || true
                return 1
              fi
              echo "‚Ä¶waiting for adb to detect emulator ($((${deadline}-SECONDS))s left)"
              sleep 5
            done
            until "$ADB_BIN" shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' | grep -q '^1$'; do
              if (( SECONDS > deadline )); then
                echo "‚ùå Emulator did not finish booting before deadline"
                tail -n 200 "$LOG_FILE" || true
                return 1
              fi
              echo "‚Ä¶waiting for Android to boot ($((${deadline}-SECONDS))s left)"
              sleep 10
            done
            return 0
          }
          while (( attempt <= MAX_ATTEMPTS )); do
            echo "‚öôÔ∏è  Starting emulator attempt $attempt/$MAX_ATTEMPTS"
            launch_emulator
            if wait_for_boot; then
              echo "‚úÖ Emulator booted successfully"
              "$ADB_BIN" shell input keyevent 82 || true
              "$ADB_BIN" devices
              break
            fi
            echo "‚ö†Ô∏è  Emulator attempt $attempt failed; retrying"
            if [ -f "$PID_FILE" ]; then
              kill "$(cat "$PID_FILE")" || true
              rm -f "$PID_FILE"
            fi
            attempt=$((attempt + 1))
            sleep 15
          done
          if (( attempt > MAX_ATTEMPTS )); then
            echo "‚ùå Emulator failed after $MAX_ATTEMPTS attempts"
            exit 1
          fi
          echo "Emulator PID recorded in $PID_FILE for later cleanup"

      - name: üåê Expo Web export test
        run: CI=1 npx expo export --platform web || echo "‚ö†Ô∏è  Web export not available in this Expo configuration"

      - name: üèó Build app for E2E
        run: npm run build:e2e:android
        env:
          EXPO_PUBLIC_API_BASE_URL: http://10.0.2.2:3000/api/v1
          CI: true

      - name: üöÄ Start backend server
        run: |
          npm run start &
          timeout 30 bash -c 'until curl -f http://localhost:3000/api/v1/health; do sleep 1; done'
        working-directory: backend
        env:
          NODE_ENV: test
          DATABASE_URL: file:./test.db
          JWT_SECRET: test-secret-key
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'test-key' }}
          FIREBASE_SERVICE_ACCOUNT_BASE64: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_BASE64 || '' }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID || 'test-project' }}

      - name: üß™ Run Detox E2E tests
        run: npm run test:e2e:android
        env:
          DETOX_CONFIGURATION: android.emu.debug
          EXPO_PUBLIC_API_BASE_URL: http://10.0.2.2:3000/api/v1

      - name: Shutdown emulator (fallback)
        if: always()
        env:
          ANDROID_HOME: /usr/lib/android-sdk
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_SA_KEY_JSON: ${{ secrets.GCP_SA_KEY_JSON }}
        run: |
          set -euo pipefail
          if [ -n "$GCP_PROJECT_ID" ] && [ -n "$GCP_SA_KEY_JSON" ]; then
            echo "GCP secrets present; emulator fallback not used"
            exit 0
          fi
          STATE_DIR="$RUNNER_TEMP/emulator-fallback"
          PID_FILE="$STATE_DIR/pid"
          ADB_BIN="$ANDROID_HOME/platform-tools/adb"
          if [ -f "$PID_FILE" ]; then
            EMU_PID=$(cat "$PID_FILE")
            echo "üîª Shutting down fallback emulator (pid $EMU_PID)"
            kill "$EMU_PID" || true
            sleep 5
          else
            echo "No emulator pid file found; nothing to shutdown"
          fi
          "$ADB_BIN" kill-server || true

      - name: üì± Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: detox-artifacts
          path: |
            artifacts/
            e2e/screenshots/
            e2e/videos/

      - name: üìä Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            e2e/test-results/
            coverage/
